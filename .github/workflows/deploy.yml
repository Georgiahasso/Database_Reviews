name: Deploy Review Dashboard

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security Check - Ensure no secrets in code
        run: |
          # Check for potential secrets in code (excluding safe references)
          if grep -r "NEXT_PUBLIC_SUPABASE_URL\|NEXT_PUBLIC_SUPABASE_ANON_KEY\|SUPABASE_SERVICE_ROLE_KEY" \
              --exclude-dir=node_modules --exclude-dir=.github --exclude="*.md" --exclude=".gitignore" --exclude="*.yml" --exclude="env.example" . | \
              grep -v "example\|dummy\|placeholder\|your_supabase_\|process\.env\.\|console\.warn" | grep -q .; then
            echo "❌ SECURITY WARNING: Potential secrets found in code!"
            echo "Please ensure all sensitive data is in environment variables only."
            echo "Found suspicious patterns:"
            grep -r "NEXT_PUBLIC_SUPABASE_URL\|NEXT_PUBLIC_SUPABASE_ANON_KEY\|SUPABASE_SERVICE_ROLE_KEY" \
                --exclude-dir=node_modules --exclude-dir=.github --exclude="*.md" --exclude=".gitignore" --exclude="*.yml" --exclude="env.example" . | \
                grep -v "example\|dummy\|placeholder\|your_supabase_\|process\.env\.\|console\.warn"
            exit 1
          fi
          echo "✅ No secrets found in code"

      - name: Check for .env files
        run: |
          if find . -name ".env*" -not -name ".env.example" | grep -q .; then
            echo "❌ SECURITY WARNING: .env files found!"
            echo "Please remove .env files before committing."
            exit 1
          fi
          echo "✅ No .env files found"

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
          echo "Installing dependencies..."
          npm install

      - name: Run linting
        run: npm run lint

      - name: Build project
        run: npm run build
        env:
          # Use dummy values for build (not real secrets)
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key-for-build-only

  deploy:
    needs: [security-check, test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build for deployment
        run: npm run build
        env:
          # Use dummy values for build (not real secrets)
          NEXT_PUBLIC_SUPABASE_URL: https://dummy.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: dummy-key-for-build-only

      - name: Deployment placeholder
        run: |
          echo "✅ Build successful - ready for deployment!"
          echo "To deploy to Vercel, add the following secrets to your repository:"
          echo "- VERCEL_TOKEN"
          echo "- VERCEL_ORG_ID" 
          echo "- VERCEL_PROJECT_ID"
          echo "Then uncomment the Vercel deployment step in the workflow."
